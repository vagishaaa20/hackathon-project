<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Safety Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <style>
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }
  </style>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#4A90E2",
            "background-light": "#f6f6f8",
            "background-dark": "#121212",
            "panel-dark": "#1E1E1E",
            "element-dark": "#2A2A2A",
            "text-light": "#E0E0E0",
            "text-dark": "#92a4c9",
            "critical": "#FF4545",
            "warning": "#FFA500"
          },
          fontFamily: {
            "display": ["Public Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-text-light">
  <div class="flex h-screen w-full flex-col">
    <!-- Top Nav Bar -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-element-dark/50 px-6 py-3 shrink-0 bg-panel-dark">
      <div class="flex items-center gap-8">
        <div class="flex items-center gap-4 text-white">
          <div class="size-6 text-primary">
            <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z" fill="currentColor"></path>
            </svg>
          </div>
          <h2 class="text-text-light text-lg font-bold leading-tight tracking-[-0.015em]">Safety Analytics</h2>
        </div>
      </div>
      <div class="flex flex-1 justify-end gap-4 items-center">
        <label class="flex flex-col min-w-40 !h-10 max-w-64">
          <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
            <div class="text-text-dark flex bg-element-dark items-center justify-center pl-3 rounded-l-lg border-r-0">
              <span class="material-symbols-outlined text-xl">search</span>
            </div>
            <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-light focus:outline-0 focus:ring-0 border-none bg-element-dark focus:border-none h-full placeholder:text-text-dark px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Search" value=""/>
          </div>
        </label>
        <div class="flex gap-2">
          <button class="relative flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-element-dark text-text-light gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
            <span class="material-symbols-outlined">notifications</span>
            <div class="absolute top-1.5 right-1.5 size-2.5 rounded-full bg-critical border-2 border-panel-dark"></div>
          </button>
          <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-element-dark text-text-light gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
            <span class="material-symbols-outlined">help</span>
          </button>
        </div>
        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User profile picture" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCIo3jdwCA0rGgB6YRGYqRBU4R4mqlV1otkhFyEE1D8Fj5BlyBoY4j7xgJ6xEYgWFRmijlzRquPk8dE4hN5JwIfEArmbFeONZmWaRhbGmQwFjycpet4kvKc9SvEbQogIi5USI5M5ps6HCc6Eg0V3efxMh933BySA37v4P8rsPNn4cQhpaXxqpXmj4Zi9IpkXRS9yUrqN-3Reu17Waxbg9Ffsq84d-5x6dCI1k7wfqtyxIc1LDvRM9b-Zqwn9zBoQ1I8aiLcdYQGXUM");'></div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Left Side Panel -->
      <aside class="flex w-80 shrink-0 flex-col bg-panel-dark border-r border-element-dark/50">
        <div class="flex h-full min-h-[700px] flex-col justify-between p-4">
          <div class="flex flex-col gap-4">
            <!-- Navigation -->
            <div class="flex flex-col gap-2">
              <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-element-dark" href="#">
                <span class="material-symbols-outlined text-primary">dashboard</span>
                <p class="text-text-light text-sm font-medium leading-normal">Dashboard</p>
              </a>
              <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-element-dark/50" href="#">
                <span class="material-symbols-outlined text-text-dark">bar_chart</span>
                <p class="text-text-light text-sm font-medium leading-normal">Reports</p>
              </a>
              <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-element-dark/50" href="#">
                <span class="material-symbols-outlined text-text-dark">settings</span>
                <p class="text-text-light text-sm font-medium leading-normal">Settings</p>
              </a>
            </div>
            <div class="border-t border-element-dark/50 my-2"></div>
            <!-- Alert Feed -->
            <h3 class="text-text-light text-lg font-bold leading-tight tracking-[-0.015em] px-2 pb-2 pt-2">Real-Time Alerts</h3>
            <div class="flex flex-col gap-1 overflow-y-auto pr-2">
              <!-- Critical Alert -->
              <div class="flex gap-4 p-3 justify-between rounded-lg bg-primary/20 border border-primary/50 cursor-pointer">
                <div class="flex items-start gap-4">
                  <div class="text-critical flex items-center justify-center rounded-lg bg-critical/10 shrink-0 size-10">
                    <span class="material-symbols-outlined">woman</span>
                  </div>
                  <div class="flex flex-1 flex-col justify-center">
                    <p class="text-text-light text-sm font-medium leading-normal">Critical: Lone Woman Detected</p>
                    <p class="text-text-dark text-xs font-normal leading-normal">CAM-04: Park Entrance</p>
                  </div>
                </div>
                <div class="shrink-0"><p class="text-text-dark text-xs font-normal leading-normal">22:15:01</p></div>
              </div>
              <!-- Warning Alert -->
              <div class="flex gap-4 p-3 justify-between rounded-lg hover:bg-element-dark/50 cursor-pointer">
                <div class="flex items-start gap-4">
                  <div class="text-warning flex items-center justify-center rounded-lg bg-warning/10 shrink-0 size-10">
                    <span class="material-symbols-outlined">groups</span>
                  </div>
                  <div class="flex flex-1 flex-col justify-center">
                    <p class="text-text-light text-sm font-medium leading-normal">Warning: Woman Surrounded</p>
                    <p class="text-text-dark text-xs font-normal leading-normal">CAM-02: City Hall Plaza</p>
                  </div>
                </div>
                <div class="shrink-0"><p class="text-text-dark text-xs font-normal leading-normal">22:14:03</p></div>
              </div>
            </div>
          </div>
          <!-- Logout -->
          <div class="flex flex-col gap-1 border-t border-element-dark/50 pt-3">
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-element-dark/50" href="#">
              <span class="material-symbols-outlined text-text-dark">logout</span>
              <p class="text-text-light text-sm font-medium leading-normal">Logout</p>
            </a>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-6">
        <div class="flex flex-col gap-6 max-w-7xl mx-auto">
          <!-- Single Active Camera Feed -->
          <div class="relative group rounded-xl overflow-hidden border-2 border-primary shadow-lg shadow-primary/20">
            <div class="relative flex flex-col justify-end p-4 aspect-video bg-black">
              <video id="user-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
              <div class="absolute top-0 right-0 m-3 px-2 py-1 bg-critical text-white text-xs font-bold rounded z-10">LIVE</div>
              <div id="detection-overlay" class="absolute inset-0 pointer-events-none"></div>
              <div class="relative z-10 flex justify-between items-end">
                <p class="text-white text-lg font-bold leading-tight">User Camera Feed</p>
                <p id="video-timestamp" class="text-text-light text-sm font-medium">--:--:--</p>
              </div>
            </div>
            <div class="absolute top-3 left-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
              <button class="bg-black/50 p-2 rounded-full text-white hover:bg-black/80"><span class="material-symbols-outlined text-base">zoom_out_map</span></button>
              <button id="mute-btn" class="bg-black/50 p-2 rounded-full text-white hover:bg-black/80"><span class="material-symbols-outlined text-base">mic</span></button>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="grid grid-cols-4 gap-4">
            <button id="process-btn" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 bg-primary text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
              <span class="material-symbols-outlined">handshake</span>
              Gesture Detection
            </button>
            <button id="emotion-btn" class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 bg-element-dark text-text-light gap-2 text-sm font-medium leading-normal hover:bg-white/10 transition-colors">
              <span class="material-symbols-outlined">mood</span>
              Facial/Emotion 
            </button>
            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 bg-element-dark text-text-light gap-2 text-sm font-medium leading-normal hover:bg-white/10 transition-colors">
              <span class="material-symbols-outlined">settings</span>
              Configure
            </button>
            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 bg-element-dark text-text-light gap-2 text-sm font-medium leading-normal hover:bg-white/10 transition-colors">
              <span class="material-symbols-outlined">info</span>
              About
            </button>
          </div>

          <!-- Processing Results Display Area -->
          <div id="results-container" class="hidden bg-element-dark p-6 rounded-xl">
            <h3 class="text-text-light text-lg font-bold mb-4">Processing Results</h3>
            <div id="results-content" class="text-text-light text-sm space-y-2"></div>
          </div>
        </div>
      </main>

      <!-- Right Details Panel -->
      <aside class="flex w-96 shrink-0 flex-col bg-panel-dark border-l border-element-dark/50 p-6 space-y-6 overflow-y-auto">
        <!-- Context Card -->
        <div class="flex flex-col gap-4 bg-element-dark p-4 rounded-xl">
          <h3 class="text-text-light text-lg font-bold">Details for CAM-04</h3>
          <div class="flex items-center gap-3 text-text-dark">
            <span class="material-symbols-outlined">videocam</span>
            <p class="text-sm">ID: CAM-04</p>
          </div>
          <div class="flex items-center gap-3 text-text-dark">
            <span class="material-symbols-outlined">calendar_today</span>
            <p class="text-sm">18 July 2024</p>
          </div>
          <div class="flex items-center gap-3 text-text-dark">
            <span class="material-symbols-outlined">schedule</span>
            <p class="text-sm">22:15:04 (UTC-5)</p>
          </div>
          <div class="flex items-start gap-3 text-text-dark">
            <span class="material-symbols-outlined mt-0.5">location_on</span>
            <div class="flex flex-col">
              <p class="text-sm font-medium text-text-light">Park Entrance</p>
              <p class="text-xs">123 Greenleaf Ave, Central City</p>
            </div>
          </div>
        </div>

        <!-- Scene Demographics -->
        <div class="flex flex-col gap-4 bg-element-dark p-4 rounded-xl">
          <h3 class="text-text-light text-lg font-bold">Scene Demographics</h3>
          <div class="flex items-center justify-around gap-4 text-center">
            <div>
              <p class="text-3xl font-bold text-primary">1</p>
              <p class="text-text-dark text-sm">Female</p>
            </div>
            <div>
              <p class="text-3xl font-bold text-text-light">0</p>
              <p class="text-text-dark text-sm">Male</p>
            </div>
          </div>
          <div class="w-full bg-background-dark rounded-full h-2.5">
            <div class="bg-primary h-2.5 rounded-full" style="width: 100%"></div>
          </div>
        </div>

        <!-- Event Log -->
        <div class="flex flex-col gap-3 bg-element-dark p-4 rounded-xl">
          <h3 class="text-text-light text-lg font-bold">Event Log</h3>
          <ul class="space-y-3 text-xs text-text-dark">
            <li class="flex gap-3"><span class="text-text-light font-mono">22:15:01</span><span class="text-critical font-medium">CRITICAL:</span> Lone Woman Detected</li>
            <li class="flex gap-3"><span class="text-text-light font-mono">22:14:58</span> System scan initiated</li>
            <li class="flex gap-3"><span class="text-text-light font-mono">22:13:20</span> Motion detected in zone</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Initialize user camera feed
    let userStream = null;
    let isMuted = false;
    
    async function initCamera() {
      try {
        const video = document.getElementById('user-video');
        userStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1920 }, 
            height: { ideal: 1080 },
            facingMode: 'user' 
          }, 
          audio: true 
        });
        video.srcObject = userStream;
        
        // Update timestamp every second
        setInterval(() => {
          const now = new Date();
          const timeString = now.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
          });
          document.getElementById('video-timestamp').textContent = timeString;
        }, 1000);
        
      } catch (error) {
        console.error('Error accessing camera:', error);
        document.getElementById('user-video').style.display = 'none';
        const overlay = document.getElementById('detection-overlay');
        overlay.innerHTML = `
          <div class="flex items-center justify-center h-full">
            <div class="text-center text-white p-4">
              <p class="text-critical text-lg font-bold mb-2">Camera Access Denied</p>
              <p class="text-sm">Please allow camera access to view live feed</p>
            </div>
          </div>
        `;
      }
    }
    
    // Mute/unmute button handler
    document.getElementById('mute-btn').addEventListener('click', function() {
      if (userStream) {
        const audioTracks = userStream.getAudioTracks();
        audioTracks.forEach(track => {
          track.enabled = isMuted;
        });
        isMuted = !isMuted;
        const icon = this.querySelector('.material-symbols-outlined');
        icon.textContent = isMuted ? 'mic_off' : 'mic';
      }
    });
    
    // Initialize camera on page load
    initCamera();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (userStream) {
        userStream.getTracks().forEach(track => track.stop());
      }
    });
    
    // Facial/Emotion Detection Button Handler
    document.getElementById('emotion-btn').addEventListener('click', async function() {
      const button = this;
      const resultsContainer = document.getElementById('results-container');
      const resultsContent = document.getElementById('results-content');
      
      // Disable button and show loading state
      button.disabled = true;
      const originalHTML = button.innerHTML;
      button.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Detecting...';
      
      try {
        const response = await fetch('http://localhost:3000/api/detect-emotion-facial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        if (!response.ok) {
          throw new Error('Failed to detect emotion and facial expression');
        }
        
        const data = await response.json();
        
        // Display results
        resultsContent.innerHTML = '';
        if (data.results && typeof data.results === 'object') {
          // Special formatting for emotion/facial detection results
          if (data.results.emotion_detection || data.results.facial_expression) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'space-y-4';
            
            // Emotion Detection Section
            if (data.results.emotion_detection) {
              const emotionSection = document.createElement('div');
              emotionSection.className = 'bg-panel-dark p-4 rounded-lg';
              emotionSection.innerHTML = `
                <h4 class="text-primary font-bold text-base mb-3 flex items-center gap-2">
                  <span class="material-symbols-outlined">sentiment_satisfied</span>
                  Emotion Detection
                </h4>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="text-text-dark font-medium">Detected Emotion:</span>
                    <span class="text-text-light font-bold text-lg">${data.results.emotion_detection.detected_emotion || 'N/A'}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-text-dark font-medium">Confidence:</span>
                    <span class="text-text-light">${(data.results.emotion_detection.confidence * 100).toFixed(1)}%</span>
                  </div>
                </div>
              `;
              resultDiv.appendChild(emotionSection);
            }
            
            // Facial Expression Section
            if (data.results.facial_expression) {
              const expressionSection = document.createElement('div');
              expressionSection.className = 'bg-panel-dark p-4 rounded-lg';
              expressionSection.innerHTML = `
                <h4 class="text-primary font-bold text-base mb-3 flex items-center gap-2">
                  <span class="material-symbols-outlined">face</span>
                  Facial Expression
                </h4>
                <div class="space-y-2">
                  <div class="flex justify-between items-center">
                    <span class="text-text-dark font-medium">Detected Expression:</span>
                    <span class="text-text-light font-bold text-lg">${data.results.facial_expression.detected_expression || 'N/A'}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-text-dark font-medium">Confidence:</span>
                    <span class="text-text-light">${(data.results.facial_expression.confidence * 100).toFixed(1)}%</span>
                  </div>
                </div>
              `;
              resultDiv.appendChild(expressionSection);
            }
            
            // Processing Info
            if (data.results.frames_processed) {
              const infoSection = document.createElement('div');
              infoSection.className = 'bg-panel-dark p-4 rounded-lg';
              infoSection.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                  <span class="text-text-dark">Frames Processed:</span>
                  <span class="text-text-light">${data.results.frames_processed}</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-2">
                  <span class="text-text-dark">Detections Found:</span>
                  <span class="text-text-light">${data.results.detections_found || 0}</span>
                </div>
              `;
              resultDiv.appendChild(infoSection);
            }
            
            resultsContent.appendChild(resultDiv);
          } else {
            // Fallback to generic display
            function displayResults(obj, parentKey = '') {
              Object.entries(obj).forEach(([key, value]) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'p-3 bg-panel-dark rounded-lg mb-2';
                
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                  resultItem.innerHTML = `
                    <div class="text-primary font-bold mb-2">${key}</div>
                    <div class="ml-4 space-y-1">
                  `;
                  const nestedContainer = resultItem.querySelector('.ml-4');
                  Object.entries(value).forEach(([nestedKey, nestedValue]) => {
                    const nestedItem = document.createElement('div');
                    nestedItem.className = 'flex justify-between items-center';
                    nestedItem.innerHTML = `
                      <span class="text-text-dark font-medium">${nestedKey}:</span>
                      <span class="text-text-light">${typeof nestedValue === 'boolean' ? (nestedValue ? 'Yes' : 'No') : nestedValue}</span>
                    `;
                    nestedContainer.appendChild(nestedItem);
                  });
                  resultItem.innerHTML += '</div>';
                } else {
                  resultItem.className = 'flex justify-between items-center p-3 bg-panel-dark rounded-lg mb-2';
                  resultItem.innerHTML = `
                    <span class="text-text-dark font-medium">${key}:</span>
                    <span class="text-text-light">${typeof value === 'boolean' ? (value ? 'Yes' : 'No') : value}</span>
                  `;
                }
                resultsContent.appendChild(resultItem);
              });
            }
            displayResults(data.results);
          }
        } else {
          resultsContent.innerHTML = `<p class="text-text-light">${data.results || data.message || 'Processing completed'}</p>`;
        }
        
        resultsContainer.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error:', error);
        resultsContent.innerHTML = `<p class="text-critical">Error: ${error.message}</p>`;
        resultsContainer.classList.remove('hidden');
      } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
    });
    
    document.getElementById('process-btn').addEventListener('click', async function() {
      const button = this;
      const resultsContainer = document.getElementById('results-container');
      const resultsContent = document.getElementById('results-content');
      
      // Disable button and show loading state
      button.disabled = true;
      button.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Processing...';
      
      try {
        const response = await fetch('http://localhost:3000/api/process-video', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        if (!response.ok) {
          throw new Error('Failed to process video');
        }
        
        const data = await response.json();
        
        // Display results
        resultsContent.innerHTML = '';
        if (data.results && typeof data.results === 'object') {
          // Function to recursively display nested objects
          function displayResults(obj, parentKey = '') {
            Object.entries(obj).forEach(([key, value]) => {
              const fullKey = parentKey ? `${parentKey}.${key}` : key;
              const resultItem = document.createElement('div');
              resultItem.className = 'p-3 bg-panel-dark rounded-lg mb-2';
              
              if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                // Nested object
                resultItem.innerHTML = `
                  <div class="text-primary font-bold mb-2">${key}</div>
                  <div class="ml-4 space-y-1">
                `;
                const nestedContainer = resultItem.querySelector('.ml-4');
                Object.entries(value).forEach(([nestedKey, nestedValue]) => {
                  const nestedItem = document.createElement('div');
                  nestedItem.className = 'flex justify-between items-center';
                  nestedItem.innerHTML = `
                    <span class="text-text-dark font-medium">${nestedKey}:</span>
                    <span class="text-text-light">${typeof nestedValue === 'boolean' ? (nestedValue ? 'Yes' : 'No') : nestedValue}</span>
                  `;
                  nestedContainer.appendChild(nestedItem);
                });
                resultItem.innerHTML += '</div>';
              } else {
                // Simple value
                resultItem.className = 'flex justify-between items-center p-3 bg-panel-dark rounded-lg mb-2';
                resultItem.innerHTML = `
                  <span class="text-text-dark font-medium">${key}:</span>
                  <span class="text-text-light">${typeof value === 'boolean' ? (value ? 'Yes' : 'No') : value}</span>
                `;
              }
              resultsContent.appendChild(resultItem);
            });
          }
          displayResults(data.results);
        } else {
          resultsContent.innerHTML = `<p class="text-text-light">${data.results || data.message || 'Processing completed'}</p>`;
        }
        
        resultsContainer.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error:', error);
        resultsContent.innerHTML = `<p class="text-critical">Error: ${error.message}</p>`;
        resultsContainer.classList.remove('hidden');
      } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<span class="material-symbols-outlined">play_arrow</span> Process Video';
      }
    });
  </script>
</body>
</html>

